<!doctype>
<html>
<head>
	<title>MediaRecorder test</title>
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
	<script>
function fail(str){alert(str+"\nPlease download the latest version of Firefox!");location.replace('http://mozilla.org/firefox');}
navigator.getUserMedia = (navigator.getUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia ||
                          navigator.webkitGetUserMedia);
if(!navigator.getUserMedia){fail('No getUserMedia() available.');}
if(!MediaRecorder){fail('No MediaRecorder available.');}
var mediaRecorder;

var socket = io();
socket.on('message',function(m){
	console.log('recv server message',m);
});
socket.on('fatal',function(m){
	console.log('recv error message',m);
	alert('Error:'+m);
	mediaRecorder.stop();
	//should reload?
});
socket.on('ffmpeg_stderr',function(m){console.log(m);});
socket.on('disconnect', function () {
	console.log('server disconnected');
	mediaRecorder.stop();
});

socket.emit('config_rtmpDestination','rtmp://127.0.0.1/live');

var constraints = { audio: true, video:{
	mandatory: {
		maxWidth: 480,
		minWidth: 480,
		maxHeight: 360,
		minHeight: 360,
	}
}};
var onSuccess = function(stream) {
	socket.emit('start','start');
	mediaRecorder = new MediaRecorder(stream);
	mediaRecorder.start(2000);

	mediaRecorder.onstop = function(e) {
		stream.stop();
	}

	mediaRecorder.ondataavailable = function(e) {
	  socket.emit("binarystream",e.data);
	  //chunks.push(e.data);
	}
}

var onError = function(err) {
	console.log('The following error occured: ' + err);
}

navigator.getUserMedia(constraints, onSuccess, onError);
	</script>
</body>
</html>