<!doctype>
<html>
<head>
	<title>MediaRecorder test</title>
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
	<script>
function fail(str){alert(str+"\nPlease download the latest version of Firefox!");location.replace('http://mozilla.org/firefox');}
navigator.getUserMedia = (navigator.getUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia ||
                          navigator.webkitGetUserMedia);
if(!navigator.getUserMedia){fail('No getUserMedia() available.');}
if(!MediaRecorder){fail('No MediaRecorder available.');}

var socket = io();
socket.on('message',function(m){
	console.log('recv server message',m);
});

var constraints = { audio: true, video:{
	mandatory: {
		maxWidth: 320,
		minWidth: 320,
		maxHeight: 180,
		minHeight: 180,
	}
}};
var onSuccess = function(stream) {
	var mediaRecorder = new MediaRecorder(stream);
	mediaRecorder.start(1000);
/*
	record.onclick = function() {
	  mediaRecorder.start();
	  console.log(mediaRecorder.state);
	  console.log("recorder started");
	  record.style.background = "red";
	  record.style.color = "black";
	}

	stop.onclick = function() {
	  mediaRecorder.stop();
	  console.log(mediaRecorder.state);
	  console.log("recorder stopped");
	  record.style.background = "";
	  record.style.color = "";
	  // mediaRecorder.requestData();
	}*/

	mediaRecorder.onstop = function(e) {
	  /*console.log("data available after MediaRecorder.stop() called.");

	  var clipName = prompt('Enter a name for your sound clip');

	  var clipContainer = document.createElement('article');
	  var clipLabel = document.createElement('p');
	  var audio = document.createElement('audio');
	  var deleteButton = document.createElement('button');
	 
	  clipContainer.classList.add('clip');
	  audio.setAttribute('controls', '');
	  deleteButton.innerHTML = "Delete";
	  clipLabel.innerHTML = clipName;

	  clipContainer.appendChild(audio);
	  clipContainer.appendChild(clipLabel);
	  clipContainer.appendChild(deleteButton);
	  soundClips.appendChild(clipContainer);

	  audio.controls = true;
	  var blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
	  chunks = [];
	  var audioURL = window.URL.createObjectURL(blob);
	  audio.src = audioURL;
	  console.log("recorder stopped");

	  deleteButton.onclick = function(e) {
	    evtTgt = e.target;
	    evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
	  }*/
	}

	mediaRecorder.ondataavailable = function(e) {
	  console.log("new data arrive",e.data);
	  socket.emit("binarystream",e.data);
	  //chunks.push(e.data);
	}
}

var onError = function(err) {
console.log('The following error occured: ' + err);
}

navigator.getUserMedia(constraints, onSuccess, onError);
	</script>
</body>
</html>